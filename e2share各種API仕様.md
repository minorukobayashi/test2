# e2share各種API仕様

## [共通仕様](#共通仕様)
* [リクエスト仕様](#リクエスト仕様)
* [レスポンス仕様](#レスポンス仕様)
* [マルチモードについて](#マルチモードについて)

## [各種API](#各種API)
* [登録API](#登録API)
* [更新API](#更新API)
* [メールAPI](#メールAPI)
* [連続オートドゥAPI](#連続オートドゥAPI)
* [イベントAPI](#イベントAPI)

=======================================================

<a id="共通仕様"></a>
# 共通仕様
<a id="リクエスト仕様"></a>
## リクエスト仕様
[各種API](#各種API)を参照してください。

<a id="レスポンス仕様"></a>
## レスポンス仕様

#### 形式
* XML

#### HTTPステータスコード
* 200 : 正常終了
* 403 : 異常終了 ERROR,WARNING
* 500 : 異常終了 FETAL

#### フォーマット

##### 通常モード

```
<?xml version="1.0" encoding="UTF-8"?>
<e2share-api>
  <user_id>実行対象ユーザID</user_id>
  <message>メッセージ</message>
</e2share-api>
```

##### マルチモード

```
<?xml version="1.0" encoding="UTF-8"?>
<e2share-api>
  <user id="実行対象ユーザID" status="HTTPステータスコード">ユーザごとのメッセージ</user>
  <user id="実行対象ユーザID" status="HTTPステータスコード">ユーザごとのメッセージ</user>
   ・
   ・
   ・
  <message>全体チェックのメッセージ</message>
</e2share-api>
```

<a id="マルチモードについて"></a>
##マルチモードについて

### 概要
e2shareAPIは1リクエストで1ユーザに対して実行するのが基本であるが、リクエストパラメータmulti=trueを与えた場合に複数ユーザに対して実行できる。これをマルチモードであるとか「マルチで実行する」などと表現する。

### リクエストパラメータ

パラメータ|説明|必須/任意
--|--
multi|trueの場合：複数のuser_idパラメータを受け付ける|任意
user_id|API実行対象のユーザIDを指定する。multi=trueが与えられている場合に複数指定可能。|登録API以外必須
deliverID|e2shareAPIコネクタのデリバリID（@$$link_url@に含まれる）|必須
pageID|e2shareAPIコネクタのページID|必須（@$$link_url@に含まれる）

### チェック仕様
* 全体チェック
  * デリバリチェック(deliverID, pageIDにAPIコネクタがデリバリされているかのチェック)
  * コネクタチェック(コネクト元サイトが正しく設定されているかチェック)
  * e2shareAPIチェック(外部制約主キー項目と外部キー制約外部キー項目のチェック)
* ユーザごとチェック
  * 全体チェックがOKの場合に実施する。
  * チェック内容は実行する各種APIの仕様に従う。

### レスポンス

#### HTTPステータスコード
* 全体チェックNGの場合、レスポンス仕様に従う。
* ユーザごとチェックNGの場合、HTTPステータスコードは200で返し、レスポンス仕様に従い算出したレスポンスコードをuser要素status属性に設定して返す。


#### 全体チェックOKの場合
```
<?xml version="1.0" encoding="UTF-8"?>
<e2share-api>
  <user id="実行対象ユーザID" status="HTTPステータスコード">ユーザごとのメッセージ</user>
  <user id="実行対象ユーザID" status="HTTPステータスコード">ユーザごとのメッセージ</user>
   ・
   ・
   ・
  <message>OK</message>
</e2share-api>
```
#### 全体チェックNGの場合
```
<?xml version="1.0" encoding="UTF-8"?>
<e2share-api>
  <user id="" status=""></user>
  <message>全体チェックのメッセージ</message>
</e2share-api>
```


<a id="各種API"></a>
# 各種API
<a id="登録API"></a>
## 登録API
### リクエストパラメータ
パラメータ名|値|必須/任意
--|--|--
multi|trueの場合マルチモードで起動|任意
userid|ユーザID|ユーザID手動発行の場合必須
password|パスワード|パスワード手動発行の場合必須

### 選択肢項目の扱い
* 選択肢インデックスではなく選択肢名を指定すること。
* 複数選択肢項目の値を複数更新する場合の区切り文字はカンマ。
* 複数選択肢項目は存在しない選択肢名を指定することで必須項目の値のクリアが可能（バグ？）。

### チェック仕様
* コネクト元サイトがID任意設定の場合使用不可（バグ？）
* コネクト元サイトがパスワード任意設定の場合、password必須
* 主キー項目チェック
  * NULL, 空値, 存在しない値は「不正なリクエストです。」
* 外部キー項目チェック
  * NULL, 空値, 一致しない値は「不正なリクエストです。」
* 必須項目チェック


<a id="更新API"></a>
## 更新API
### リクエストパラメータ
パラメータ名|値|必須/任意
--|--|--
multi|trueの場合マルチモードで起動|任意
user_id|API実行対象ユーザID|必須
e2share_update_api_all_item*|true|任意
v*|バージョン指定|任意

*e2share_update_api_all_itemはサイトプロパティの全項目更新オプションが有効の場合のみ利用可能。詳細は全項目更新オプションの項参照

### 選択肢項目の扱い
* 選択肢インデックスではなく選択肢名を指定すること。
* 複数選択肢項目の値を複数更新する場合の区切り文字はカンマ。
* 選択肢項目で存在しない選択肢名を指定した場合の動作は以下の通り。
　バージョン=1の場合、値をクリア
　バージョン=1以外の場合、「不正アクセスエラー」


### チェック仕様
* 主キー項目チェック
  * NULL, 空値, 存在しない値は「不正なリクエストです。」
* 外部キー項目チェック
  * NULL, 空値, 一致しない値は「不正なリクエストです。」
* 必須項目チェック
* 選択肢項目
  * バージョン=1以外の場合、存在しない選択肢名を指定すると「不正アクセスエラー」

### 全項目更新オプション
* サイトプロパティのe2share_update_api_all_itemが有効の場合、全項目更新オプションが有効となり、リクエストパラメータで指定した項目の更新が可能となる。コネクタ項目に設定する必要はなく、リクエストできる対象項目は全項目となる。

### 特記事項
* 更新APIコネクタに指定された項目をリクエストしない場合、値がクリアされることに注意。その場合は、全項目更新オプションの利用を検討する。リクエストした項目が自由に更新できることになるため、応募者側での利用は推奨しない。


<a id="メールAPI"></a>
## メールAPI
### リクエストパラメータ
パラメータ名|値|必須/任意
--|--|--
multi|trueの場合マルチモードで起動|任意
user_id|API実行対象ユーザID|必須
mail_from|メールの送信元アドレス（キーワード指定可）|コネクタ設定の「From（送信元）」が「リクエストパラメータ指定」の場合必須
mail_subject|メールの件名|必須
mail_message|メールの本文|必須
mail_timestamp|タイムスタンプ（13桁の数字）|必須


### チェック仕様
* mail_fromチェック
  * コネクタ設定の「From（送信元）」が「リクエストパラメータ指定」の場合
    * 値がメールアドレスの場合、NULLチェック、空文字チェック、lengthチェック(128文字)
    * 値が個人情報項目キーワードの場合、キーワードチェック（メールアドレスタイプのみ許可）
* mail_subjectチェック
  * NULLチェック、空文字チェック、lengthチェック(128文字)
* mail_messageチェック
  * NULLチェック、空文字チェック、lengthチェック(102400文字)
* timestampチェック
  * NULLチェック、空文字チェック、数値チェック、桁数チェック(13桁)


<a id="連続オートドゥAPI"></a>
## 連続オートドゥAPI
### リクエストパラメータ
パラメータ名|値|必須/任意
--|--|--
multi|trueの場合マルチモードで起動|任意
user_id|API実行対象ユーザID|必須


### チェック仕様
* user_idチェック



<a id="イベントAPI"></a>
## イベントAPI
### リクエストパラメータ
パラメータ名|値|必須/任意
--|--|--
multi|trueの場合マルチモードで起動|任意
user_id|API実行対象ユーザID|必須
action_id|3=予約/4=キャンセル/5=予約変更|必須
event_id|予約/キャンセル/予約変更の対象イベントID (9=空席通知登録/10=空席通知解除 はイベントAPI未対応？)|必須
schedule_id|予約/キャンセル/予約変更の対象日程ID|必須
room_no|部屋番号|任意


### チェック仕様
* user_idチェック
* action_idチェック
  * 必須チェック、規定値チェック
  * action_id=5(予約変更)の場合 かつ
    * 複数予約制限が「制限する」の場合
      * 予約済み日程の存在チェック
    * 複数予約制限が「制限しない」の場合
      * 予約変更不可のためエラー「アクションIDを正しく入力してください。」

* event_id
  * 数値チェック、lengthチェック、存在チェック
* schedule_id
  * 数値チェック、lengthチェック、存在チェック
* リクエストパラメータroom_noが与えられていてかつ、action_id=3(予約) もしくは action_id=5(予約変更)の場合 かつ
  * 部屋番号割振実行区分が「する」の場合
    * room_noの数値チェック、予約可能な部屋の存在チェック
